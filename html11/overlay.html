<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <title>go2rtc WHEP Viewer</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      body {
        margin: 0;
        padding: 24px;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        background: #0f172a;
        color: #f8fafc;
      }
      h1 {
        margin-top: 0;
        font-size: 1.75rem;
      }
      .controls {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        margin-bottom: 18px;
      }
      label {
        font-size: 0.85rem;
        display: flex;
        flex-direction: column;
        gap: 6px;
      }
      input {
        padding: 8px 10px;
        border-radius: 6px;
        border: 1px solid rgba(148, 163, 184, 0.4);
        background: rgba(15, 23, 42, 0.6);
        color: inherit;
        min-width: 220px;
      }
      button {
        padding: 10px 18px;
        border-radius: 999px;
        border: none;
        cursor: pointer;
        font-weight: 600;
        background: #38bdf8;
        color: #0f172a;
        transition: transform 0.15s ease, box-shadow 0.15s ease;
      }
      button:hover {
        transform: translateY(-1px);
        box-shadow: 0 6px 18px rgba(56, 189, 248, 0.25);
      }
      button.secondary {
        background: rgba(148, 163, 184, 0.25);
        color: inherit;
      }
      video {
        width: 100%;
        max-width: 960px;
        aspect-ratio: 16 / 9;
        background: #020617;
        border-radius: 12px;
        border: 1px solid rgba(148, 163, 184, 0.25);
        object-fit: contain;
      }
      .status {
        margin-top: 12px;
        font-size: 0.9rem;
        color: #bae6fd;
      }
      .status.error {
        color: #fca5a5;
      }
      .status.success {
        color: #86efac;
      }
    </style>
  </head>
  <body>
    <h1>go2rtc WebRTC (WHEP) Viewer</h1>
    <p>輸入要拉取的串流 ID（例如 <code>cam1_overlay</code>），點選「開始播放」即可使用 WHEP + WebRTC 觀看影像。</p>

    <div class="controls">
      <label>
        go2rtc API
        <input
          id="api-url"
          type="text"
          value="http://localhost:1984"
          placeholder="http://localhost:1984"
        />
      </label>
      <label>
        Stream / src
        <input id="stream-name" type="text" value="cam1_overlay" placeholder="cam1_overlay" />
      </label>
      <button id="start-btn">開始播放</button>
      <button id="stop-btn" class="secondary">停止</button>
    </div>

    <video id="player" autoplay playsinline muted></video>
    <div id="status" class="status"></div>

    <script>
      let pc = null

      const statusEl = document.getElementById("status")
      const startBtn = document.getElementById("start-btn")
      const stopBtn = document.getElementById("stop-btn")
      const player = document.getElementById("player")
      const streamInput = document.getElementById("stream-name")
      const apiInput = document.getElementById("api-url")

      function setStatus(message, type = "") {
        statusEl.textContent = message || ""
        statusEl.className = "status" + (type ? ` ${type}` : "")
      }

      async function start() {
        const streamId = streamInput.value.trim()
        const apiUrl = apiInput.value.trim().replace(/\/$/, "")

        if (!streamId) {
          setStatus("請輸入 stream 名稱", "error")
          return
        }
        if (!apiUrl) {
          setStatus("請輸入 go2rtc API 位址", "error")
          return
        }

        stop()

        try {
          setStatus("建立 WebRTC 連線中…")

          pc = new RTCPeerConnection({
            iceServers: [{ urls: "stun:stun.l.google.com:19302" }],
          })

          pc.addTransceiver("video", { direction: "recvonly" })
          pc.addTransceiver("audio", { direction: "recvonly" })

          pc.ontrack = (event) => {
            if (event.streams && event.streams[0]) {
              player.srcObject = event.streams[0]
              setStatus(`串流 ${streamId} 已連線`, "success")
            }
          }

          pc.oniceconnectionstatechange = () => {
            if (!pc) return
            const state = pc.iceConnectionState
            if (state === "failed" || state === "disconnected") {
              setStatus("連線中斷，請重新開始。", "error")
            }
          }

          const offer = await pc.createOffer()
          await pc.setLocalDescription(offer)

          const response = await fetch(`${apiUrl}/api/webrtc?src=${encodeURIComponent(streamId)}`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              type: "offer",
              sdp: offer.sdp,
            }),
          })

          if (!response.ok) {
            const errorText = await response.text()
            throw new Error(
              `WHEP 連線失敗 (${response.status})${errorText ? `：${errorText}` : ""}`,
            )
          }

          const answerPayload = await response.json()
          const answerSdp = answerPayload?.sdp
          if (!answerSdp) {
            throw new Error("go2rtc response missing SDP")
          }

          await pc.setRemoteDescription({ type: "answer", sdp: answerSdp })
          setStatus(`已成功建立與 ${streamId} 的 WebRTC 連線`, "success")
        } catch (error) {
          console.error("WHEP 播放錯誤", error)
          setStatus(error instanceof Error ? error.message : "播放失敗", "error")
          stop()
        }
      }

      function stop() {
        if (pc) {
          pc.ontrack = null
          pc.oniceconnectionstatechange = null
          pc.getSenders().forEach((sender) => sender.track && sender.track.stop())
          pc.getReceivers().forEach((receiver) => receiver.track && receiver.track.stop())
          pc.close()
          pc = null
        }
        if (player.srcObject instanceof MediaStream) {
          player.srcObject.getTracks().forEach((track) => track.stop())
        }
        player.srcObject = null
        setStatus("已停止播放")
      }

      startBtn.addEventListener("click", () => {
        start()
      })

      stopBtn.addEventListener("click", () => {
        stop()
      })

      window.addEventListener("beforeunload", () => {
        stop()
      })
    </script>
  </body>
</html>
