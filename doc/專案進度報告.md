# AI Hub 專案進度報告

**報告日期**: 2025-12-31  
**專案名稱**: AI Hub - 智慧視覺串流平台  
**專案階段**: 開發階段

---

## 📊 專案概覽

### 專案目標
建立一套以影像串流處理為核心的智慧視覺平台，整合多路視訊串流管理、AI 物件偵測、行為辨識、虛擬圍欄告警與事件管理功能。

### 技術架構
- **後端服務**: Python + OpenCV, FFmpeg, Go (go2rtc)
- **AI 推理**: YOLOv7/YOLOv8
- **前端介面**: Next.js 16
- **訊息佇列**: MQTT (Mosquitto)
- **資料庫**: PostgreSQL 16
- **部署方式**: Docker Compose

---

## ✅ 已完成項目

### 1. 核心串流系統 (100%)

#### 1.1 視訊擷取與轉推
- ✅ **raw_restreamer**: FFmpeg 從 USB 攝影機擷取並轉推至 go2rtc
  - 支援 `/dev/video0` 擷取 640×480 @ 10 FPS
  - 可配置 RTSP 輸出至 `cam1_raw`

#### 1.2 串流伺服器
- ✅ **go2rtc**: 多協議串流轉換
  - RTSP 輸入/輸出 (Port 8554)
  - WebRTC 串流 (Port 8555)
  - HTTP API (Port 1984)
  - 支援 HLS 播放

#### 1.3 AI 疊加服務
- ✅ **action_recognition_server**: 即時影像處理
  - 使用 OpenCV 讀取串流
  - 實作 `draw_overlay` 函式框架
  - 支援 VAAPI 硬體加速
  - 輸出疊加後串流至 `cam1_overlay`

### 2. AI 模型整合系統 (100%)

#### 2.1 動態模型載入
- ✅ **model_launcher**: 模型推論服務
  - 支援 YOLOv7/YOLOv8 動態切換
  - 從 `models.json` 讀取模型配置
  - 推論結果透過 MQTT 發布
  - Topic: `vision/{camera_id}/detections`

#### 2.2 虛擬圍欄偵測
- ✅ **fence**: 入侵偵測服務
  - Ray Casting 演算法判斷物件是否進入圍欄
  - 讀取 `cameras.json` 中的虛擬圍欄配置
  - 支援多邊形區域定義 (正規化座標)
  - 冷卻期機制避免重複告警
  - 事件發布至 MQTT: `vision/{camera_id}/events`

### 3. 事件記錄系統 (100%)

#### 3.1 持續錄影
- ✅ **record**: 自動錄影服務
  - 從 go2rtc 拉取串流進行錄影
  - 輸出格式: MKV (H264 + AAC)
  - 分段錄影機制
  - 儲存至 `share/recordings/`

#### 3.2 事件裁剪
- ✅ 事件觸發時自動裁剪影片片段
  - 事件前後 N 秒緩衝
  - 獨立儲存事件影片
  - 產生縮圖

#### 3.3 資料持久化
- ✅ **PostgreSQL**: 事件資料庫
  - events 表結構設計完成
  - 儲存事件時間戳、相機ID、類別、信心度、圍欄資訊
  - pgAdmin 管理介面 (Port 5050)

### 4. Web 前端介面開發 (90%)

#### 4.1 前端 UI 設計與開發 ✅
- ✅ **html16**: Next.js 16 儀表板頁面
  - 攝影機管理介面 (新增/編輯/刪除)
  - 虛擬圍欄繪製介面 (Canvas 多邊形繪製)
  - 事件瀏覽與篩選介面
  - 錄影檔案管理介面
  - 響應式設計完成

#### 4.2 串流播放功能 ✅
- ✅ **播放器整合**
  - HLS 播放器整合
  - WebRTC 播放器整合
  - 串流狀態顯示
  - 多畫面同步播放

#### 4.3 前後端整合 🔄 (進行中)
- 🔄 **REST API 串接** - 待完成
  - 事件查詢 API 串接
  - 錄影檔案列表 API
  - 虛擬圍欄配置儲存
- 🔄 **WebSocket 即時通訊** - 待完成
  - MQTT over WebSocket 連線
  - 即時事件通知接收
  - 告警推送顯示
- 🔄 **資料庫整合** - 待完成
  - PostgreSQL 事件查詢
  - 事件統計資料讀取
  - 錄影檔案元資料同步

### 5. MQTT 整合 (100%)

- ✅ **Mosquitto Broker**: MQTT 訊息佇列
  - Port 1883 (MQTT)
  - Port 9001 (WebSocket)
  - Topic 架構設計:
    - `vision/{camera_id}/detections` - AI 偵測結果
    - `vision/{camera_id}/events` - 圍欄事件
  - Web UI 透過 WebSocket 訂閱即時事件

---

## 🚧 進行中項目

### 1. 前後端整合 (優先級: P0 - 最高)
- 🔄 **REST API 開發與串接**
  - 後端 API 端點設計
  - 攝影機管理 API (GET/POST/PUT/DELETE)
  - 事件查詢 API (分頁、篩選)
  - 錄影檔案 API (列表、播放、下載)
  - 前端 API Client 實作
  - 錯誤處理與重試機制

- 🔄 **即時通訊整合**
  - MQTT WebSocket 客戶端實作
  - 事件訂閱與推送
  - 前端事件處理器
  - Toast 通知系統串接

- 🔄 **資料流整合**
  - PostgreSQL 與前端資料同步
  - 事件資料渲染
  - 影片路徑解析
  - 縮圖顯示功能

### 2. AI 模型訓練與優化
- 🔄 自訂行為辨識模型訓練
  - 資料集準備中
  - 目標行為: jumping, sitting_down, standing_up, bending, falling_down, picking_up_object

### 3. 系統效能優化
- 🔄 硬體加速調校
  - VAAPI 編碼參數優化
  - GPU 資源分配

---

## 📋 待辦項目

### 1. 功能增強 (優先級: P2)

#### 1.1 告警系統增強
- ⏳ Email 告警通知
- ⏳ Webhook 整合
- ⏳ 告警規則自訂

#### 1.2 報表功能
- ⏳ 事件統計報表
- ⏳ 每日/每週摘要
- ⏳ 匯出功能 (CSV/PDF)

#### 1.3 使用者權限管理
- ⏳ 使用者登入/登出
- ⏳ 角色權限控制
- ⏳ 操作日誌

### 2. 系統穩定性 (優先級: P1)

- ⏳ 單元測試覆蓋率提升
- ⏳ 整合測試腳本
- ⏳ 錯誤處理機制強化
- ⏳ 服務健康檢查

### 3. 部署與維運 (優先級: P2)

- ⏳ Docker 映像檔優化
- ⏳ 環境變數統一管理
- ⏳ 備份與還原機制
- ⏳ 監控儀表板 (Prometheus + Grafana)

---

## 🎯 關鍵里程碑

| 里程碑 | 目標日期 | 狀態 | 完成度 |
|--------|---------|------|--------|
| 基礎架構搭建 | 2025-01-15 | ✅ 完成 | 100% |
| 串流系統整合 | 2025-01-30 | ✅ 完成 | 100% |
| AI 模型整合 | 2025-02-15 | ✅ 完成 | 100% |
| 虛擬圍欄系統 | 2025-02-28 | ✅ 完成 | 100% |
| 後端服務開發 | 2025-03-15 | ✅ 完成 | 100% |
| 前端介面開發 | 2025-03-30 | ✅ 完成 | 100% |
| **前後端整合** | **2025-04-15** | **🔄 進行中** | **30%** |
| 事件記錄系統 | 2025-04-30 | ✅ 完成 | 100% |
| 自訓模型整合 | 2025-06-01 | 🔄 進行中 | 60% |
| 整合測試 | 2025-06-15 | ⏳ 待開始 | 0% |
| 效能優化 | 2025-07-01 | ⏳ 待開始 | 0% |

---

## 📈 系統規格

### 當前配置

| 項目 | 規格 |
|------|------|
| 支援相機數 | 1 台 (可擴展) |
| 串流解析度 | 640×480 ~ 1920×1080 |
| 串流幀率 | 10-30 FPS |
| AI 模型 | YOLOv7, YOLOv8 |
| 偵測類別 | person, book, tv, 6 種行為 |
| 儲存容量 | 依主機配置 |
| 並發用戶 | 10+ (Web UI) |

### 效能指標

| 指標 | 數值 |
|------|------|
| 端到端延遲 | < 500ms |
| AI 推論速度 | 15-30 FPS (取決於硬體) |
| 串流穩定性 | 99%+ |
| 事件偵測延遲 | < 100ms |

---

## 🔧 技術債務

### 高優先級
1. ⚠️ **前後端 API 規格未定義** - 需建立完整 API 文件
2. ⚠️ **WebSocket 連線機制待實作** - MQTT over WS 整合
3. ⚠️ 錯誤處理機制需強化 (特別是串流中斷情況)
4. ⚠️ 資料庫索引優化 (事件查詢效能)

### 中優先級
1. 📌 日誌系統統一 (目前分散在各服務)
2. 📌 Docker 映像檔大小優化 (目前約 2GB)
3. 📌 環境變數配置簡化

---

## 🎓 團隊學習成果

### 已掌握技術
- ✅ Docker Compose 多服務編排
- ✅ RTSP/WebRTC 串流處理
- ✅ MQTT 訊息佇列應用
- ✅ YOLOv8 物件偵測整合
- ✅ Next.js 16 App Router 開發
- ✅ PostgreSQL 資料庫設計
- ✅ FFmpeg 影像處理
- ✅ Canvas API 圖形繪製

---

## 🚀 下一步計畫

### 短期目標 (1-2 週)
1. **完成前後端 API 串接** (最高優先)
2. **實作 WebSocket 即時通訊**
3. **整合 PostgreSQL 事件資料顯示**
4. 基本功能整合測試

### 中期目標 (1-2 個月)
1. 增強告警系統功能
2. 實作報表功能
3. 使用者權限系統

### 長期目標 (2-3 個月)
1. 支援更多 AI 模型
2. 雲端部署方案
3. 行動裝置 APP

---

## 📞 問題與挑戰

### 已解決問題
1. ✅ RTSP 串流不穩定 → 增加重連機制
2. ✅ VAAPI 硬體加速失敗 → 自動 fallback 到軟編碼
3. ✅ WebRTC 播放延遲 → 調整緩衝參數

### 當前挑戰
1. 🔍 **前後端整合架構設計** - API 規格與資料流定義
2. 🔍 **即時資料同步機制** - WebSocket 與 MQTT 整合
3. 🔍 自訓模型準確率需提升
4. 🔍 多相機並發時 CPU 使用率較高

---

## 💡 創新亮點

1. **模組化架構**: 每個功能獨立容器，易於維護與擴展
2. **即時 AI 處理**: 低延遲的物件偵測與行為辨識
3. **虛擬圍欄**: 靈活的多邊形區域定義與入侵偵測
4. **事件驅動**: MQTT 訊息佇列實現服務解耦
5. **完整文件**: SRS, PRD, SDD 齊全，利於團隊協作

---

## 📊 專案統計

| 項目 | 數量 |
|------|------|
| Docker 服務 | 9 個 |
| Python 程式檔 | 15+ |
| 配置檔案 | 10+ |
| API 端點 | 20+ |
| MQTT Topics | 4+ |
| 資料庫表格 | 5+ |
| 文件頁數 | 200+ |
| Git Commits | 14 |

---

## 📝 總結

本專案已成功建立智慧視覺串流平台的**後端服務架構**與**前端介面設計**，各獨立模組運作穩定。系統架構清晰、文件完善，具備良好的擴展性與維護性。

**整體進度**: 約 **70%** 完成

- **已完成**: 
  - ✅ 後端核心服務 (串流、AI、錄影、事件偵測)
  - ✅ 前端 UI 介面設計與開發
  - ✅ 系統架構與文件撰寫
  
- **進行中**: 
  - 🔄 **前後端 API 整合** (當前重點)
  - 🔄 WebSocket 即時通訊
  - 🔄 資料庫與前端資料流整合
  
- **待辦**: 
  - ⏳ 整合測試與除錯
  - ⏳ 進階功能增強
  - ⏳ 效能優化

### 當前狀態說明

後端服務（串流、AI 推論、虛擬圍欄、錄影、MQTT）與前端介面（Next.js 儀表板）已分別開發完成，但**前後端尚未進行API串接與資料整合**。接下來的主要工作是建立完整的 REST API，實作 WebSocket 通訊，並將後端的事件資料與前端介面整合，使整個系統能夠端到端運作。

---

**報告人**: Lab321 團隊  
**審核**: 待審  
**下次更新**: 2025-01-15
