services:

  # 從 /dev/video0 拉原始畫面 → 推到 cam1_raw，供 action_recognition_server 取用
  raw_restreamer:
    image: jrottenberg/ffmpeg:6.1-ubuntu
    container_name: raw_restreamer
    restart: unless-stopped
    depends_on: [go2rtc]
    devices:
      - /dev/video0:/dev/video0
    command: >
      -f v4l2 -input_format yuyv422 -framerate 10 -video_size 640x480 -i /dev/video0
      -vf format=yuv420p
      -c:v libx264 -preset veryfast -tune zerolatency
      -g 20 -keyint_min 20 -b:v 2M -maxrate 2M -bufsize 4M
      -rtsp_transport tcp
      -f rtsp rtsp://publisher:secret@go2rtc:8554/cam1_raw

  # 你的行為辨識前處理（疊字→回推 RTSP）
  action_recognition_server:
    #user: "${HOST_UID}:${HOST_GID}"
    environment:
      CAMERAS_JSON: /app/share/cameras.json
      EVENTS_JSON: /app/share/events.json
      RECORDINGS_JSON: /app/share/recordings.json
      EVENTS_DIR: /app/share/events
      RECORDINGS_DIR: /app/share/recordings
    build:
      context: .
      dockerfile: app/Dockerfile
    container_name: action_recognition_server
    restart: unless-stopped
    env_file: app/.env
    depends_on:
      - go2rtc
    devices:
      - /dev/dri:/dev/dri      # Intel iGPU 給 VAAPI 用
    volumes:
      - ./share:/app/share:ro         # 只讀 cameras.json
    # 可選：保命線
    # deploy:
    #   resources:
    #     limits:
    #       cpus: "2.0"
    #       memory: 2g
  go2rtc:
    image: alexxit/go2rtc:latest
    container_name: go2rtc
    restart: unless-stopped
    environment:
      GO2RTC_CANDIDATE: 127.0.0.1:8555
    ports:
      - "8555:8555/tcp"  # WebRTC
      - "8555:8555/udp"
      - "1984:1984"      # go2rtc API & Web UI
      - "8554:8554"      # go2rtc RTSP
    volumes:
      - ./go2rtc/go2rtc-config.yaml:/config/go2rtc.yaml  # 你自己準備的設定檔
  web:
    image: nginx:1.25-alpine
    container_name: html_test_web
    restart: unless-stopped
    depends_on:
      - go2rtc
    ports:
      - "8080:80"
    volumes:
      - ./html_test/index.html:/usr/share/nginx/html/index.html:ro
      - ./html_test/nginx.conf:/etc/nginx/conf.d/default.conf:ro


  htmlv2:
    user: "${HOST_UID}:${HOST_GID}"
    build:
      context: ./html13
      dockerfile: Dockerfile
    container_name: html13_web
    restart: unless-stopped
    depends_on:
      - go2rtc
    environment:
      GO2RTC_API_URL: http://go2rtc:1984
      NEXT_PUBLIC_GO2RTC_URL: http://localhost:1984
      CAMERAS_JSON: /app/share/cameras.json
      EVENTS_JSON: /app/share/events.json
      RECORDINGS_JSON: /app/share/recordings.json
      EVENTS_DIR: /app/share/events
      RECORDINGS_DIR: /app/share/recordings
    ports:
      - "3000:3000"
    volumes:
      - ./share:/app/share:rw         # 可讀寫 cameras.json
    



  # Frigate 建議吃 overlay 後的串流（避免雙重解碼）
  #frigate:
  #  container_name: frigate
  #  privileged: true
  #  restart: unless-stopped
  #  shm_size: "1gb"
  #  devices:
  #    - /dev/video0:/dev/video0   # 若不需要 USB cam 可拿掉
  #  depends_on:
  #    - mediamtx
  #    - mosquitto
  #  ports:
  #    - "5000:5000"          # Frigate Web UI
  #    - "8554:8554"          # go2rtc RTSP
  #   - "8555:8555/tcp"      # go2rtc WebRTC/LL-HLS
  #    - "8555:8555/udp"
  #  environment:
  #    FRIGATE_RTSP_PASSWORD: ""
  #  volumes:
  #    - ./frigate/config:/config
  #    - ./frigate/media:/media/frigate
  #    - /etc/localtime:/etc/localtime:ro
  #    - /dev/bus/usb:/dev/bus/usb  # 有 Coral 再保留
