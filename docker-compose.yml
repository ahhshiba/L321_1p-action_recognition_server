services:

  # 從 /dev/video0, video2, video4 拉原始畫面 → 推到 cam1_raw, cam2_raw, cam3_raw
  raw_restreamer:
    image: jrottenberg/ffmpeg:6.1-ubuntu
    container_name: raw_restreamer
    restart: unless-stopped
    depends_on: [go2rtc]
    devices:
      - /dev/video0:/dev/video0
      - /dev/video2:/dev/video2
      - /dev/video4:/dev/video4
    entrypoint: /bin/bash
    command:
      - -c
      - |
        ffmpeg -f v4l2 -input_format mjpeg -framerate 10 -video_size 320x240 -i /dev/video0 \
          -vf format=yuv420p -c:v libx264 -preset veryfast -tune zerolatency \
          -g 20 -keyint_min 20 -b:v 800k -maxrate 800k -bufsize 1600k \
          -rtsp_transport tcp -f rtsp rtsp://publisher:secret@go2rtc:8554/cam1_raw &
        sleep 5 ;
        ffmpeg -f v4l2 -input_format mjpeg -framerate 10 -video_size 320x240 -i /dev/video2 \
          -vf format=yuv420p -c:v libx264 -preset veryfast -tune zerolatency \
          -g 20 -keyint_min 20 -b:v 800k -maxrate 800k -bufsize 1600k \
          -rtsp_transport tcp -f rtsp rtsp://publisher:secret@go2rtc:8554/cam2_raw &
        sleep 5 ;
        ffmpeg -f v4l2 -input_format mjpeg -framerate 10 -video_size 320x240 -i /dev/video4 \
          -vf format=yuv420p -c:v libx264 -preset veryfast -tune zerolatency \
          -g 20 -keyint_min 20 -b:v 800k -maxrate 800k -bufsize 1600k \
          -rtsp_transport tcp -f rtsp rtsp://publisher:secret@go2rtc:8554/cam3_raw &
        wait

  # 你的行為辨識前處理（疊字→回推 RTSP）
  action_recognition_server:
    image: ${DOCKERHUB_USER}/action-recognition-server:${TAG}
    environment:
      CAMERAS_JSON: /app/share/cameras.json
      EVENTS_JSON: /app/share/events.json
      RECORDINGS_JSON: /app/share/recordings.json
      EVENTS_DIR: /app/share/events
      RECORDINGS_DIR: /app/share/recordings
    build:
      context: .
      dockerfile: app/Dockerfile
    container_name: action_recognition_server
    restart: unless-stopped
    env_file: app/.env
    depends_on:
      - go2rtc
    devices:
      - /dev/dri:/dev/dri      # Intel iGPU 給 VAAPI 用
    volumes:
      - ./share:/app/share:ro         # 只讀 cameras.json

  model_launcher:
    image: ${DOCKERHUB_USER}/model-launcher:${TAG}
    build:
      context: .
      dockerfile: models_classify/Dockerfile
    container_name: model_launcher
    restart: unless-stopped
    env_file: app/.env
    environment:
      CAMERAS_JSON: /app/share/cameras.json
      MODELS_JSON: /app/share/models.json
      STREAM_HOST_INTERNAL: go2rtc
      STREAM_PORT_INTERNAL: "8554"

      #  給 launcher.py 傳給 yolov8_inference.py 用的 MQTT 設定
      MQTT_HOST: mqtt          # 就是下面那個 mqtt service 的名稱
      MQTT_PORT: "1883"
      # MQTT_TOPIC 不填的話，runner 會用預設：vision/<cameraId>/detections
      # MQTT_TOPIC: "vision/global/detections"
      # 若未來要開帳密再打開這兩行
      # MQTT_USERNAME: youruser
      # MQTT_PASSWORD: yourpass
      # MQTT_QOS: "0"
    depends_on:
      - go2rtc
      - mqtt
    volumes:
      - ./share:/app/share:ro
      - ./models_classify/models:/models:ro
      - ./models_classify/class:/class:ro

  fence:
    image: ${DOCKERHUB_USER}/fence:${TAG}
    build:
      context: .
      dockerfile: fence/Dockerfile
    container_name: fence
    restart: unless-stopped
    depends_on:
      - mqtt
      - postgres
    environment:
      CAMERAS_JSON: /app/share/cameras.json
      MQTT_HOST: mqtt
      MQTT_PORT: "1883"
      MQTT_TOPIC: vision/+/detections
      DATABASE_HOST: postgres
      DATABASE_PORT: "5432"
      DATABASE_NAME: vision
      DATABASE_USER: vision_user
      DATABASE_PASSWORD: vision_pass
      FENCE_COOLDOWN_SEC: "0"
      FENCE_LEAVE_SEC: "5"
    volumes:
      - ./share:/app/share:ro

  record:
    image: ${DOCKERHUB_USER}/record:${TAG}
    build:
      context: .
      dockerfile: record/Dockerfile
    container_name: record
    restart: unless-stopped
    depends_on:
      - go2rtc
      - mqtt
      - postgres
    environment:
      CAMERAS_JSON: /app/share/cameras.json
      EVENTS_DIR: /app/share/events
      RECORDINGS_DIR: /app/share/recordings
      MQTT_HOST: mqtt
      MQTT_PORT: "1883"
      MQTT_TOPIC: vision/+/events
      STREAM_HOST_INTERNAL: go2rtc
      STREAM_PORT_INTERNAL: "8554"
      DATABASE_HOST: postgres
      DATABASE_PORT: "5432"
      DATABASE_NAME: vision
      DATABASE_USER: vision_user
      DATABASE_PASSWORD: vision_pass
      SEGMENT_SECONDS: "300"
      EVENT_PRE_SECONDS: "10"
      EVENT_POST_SECONDS: "10"
      EVENT_BUFFER_ENABLED: "1"
      EVENT_BUFFER_DIR: /app/share/recordings_buffer
      EVENT_BUFFER_SEGMENT_SECONDS: "1"
      EVENT_BUFFER_SECONDS: "10"
      EVENT_BUFFER_REENCODE: "1"
      EVENT_BUFFER_GOP: "10"
      TZ: UTC
    volumes:
      - ./share:/app/share:rw
      - ./share/recordings_buffer:/app/share/recordings_buffer:rw


  go2rtc:
    image: alexxit/go2rtc:latest
    container_name: go2rtc
    restart: unless-stopped
    environment:
      GO2RTC_CANDIDATE: 127.0.0.1:8555
    ports:
      - "8555:8555/tcp"  # WebRTC
      - "8555:8555/udp"
      - "1984:1984"      # go2rtc API & Web UI
      - "8554:8554"      # go2rtc RTSP
    volumes:
      - ./go2rtc/go2rtc-config.yaml:/config/go2rtc.yaml  # 你自己準備的設定檔
  #web:
  #  image: nginx:1.25-alpine
  #  container_name: html_test_web
  #  restart: unless-stopped
  #  depends_on:
  #    - go2rtc
  #  ports:
  #    - "8080:80"
  #  volumes:
  #    - ./html_test/index.html:/usr/share/nginx/html/index.html:ro
  #    - ./html_test/nginx.conf:/etc/nginx/conf.d/default.conf:ro


  htmlv2:
    image: ${DOCKERHUB_USER}/html63-web:${TAG}
    user: "${HOST_UID}:${HOST_GID}"
    build:
      context: ./html63
      dockerfile: Dockerfile
    container_name: html63_web
    restart: unless-stopped
    depends_on:
      - go2rtc
      - postgres
    environment:
      GO2RTC_API_URL: http://go2rtc:1984
      NEXT_PUBLIC_GO2RTC_URL: http://localhost:1984
      CAMERAS_JSON: /app/share/cameras.json
      EVENTS_JSON: /app/share/events.json
      RECORDINGS_JSON: /app/share/recordings.json
      EVENTS_DIR: /app/share/events
      RECORDINGS_DIR: /app/share/recordings
      MODELS_JSON: /app/share/models.json
      DATABASE_HOST: postgres
      DATABASE_PORT: "5432"
      DATABASE_NAME: vision
      DATABASE_USER: vision_user
      DATABASE_PASSWORD: vision_pass
    ports:
      - "3000:3000"
    volumes:
      - ./share:/app/share:rw         # 可讀寫 cameras.json

  mqtt:
    image: eclipse-mosquitto:2
    container_name: mqtt
    restart: unless-stopped
    ports:
      - "1883:1883"              # 給 host / 外部測試用
    volumes:
      - ./MQTT/mosquitto.conf:/mosquitto/config/mosquitto.conf
      - ./MQTT/data:/mosquitto/data
      - ./MQTT/log:/mosquitto/log

  postgres:
    image: postgres:16
    container_name: postgres
    restart: unless-stopped
    environment:
      POSTGRES_DB: vision
      POSTGRES_USER: vision_user
      POSTGRES_PASSWORD: vision_pass
      TZ: Asia/Taipei
    ports:
      - "5432:5432"
    volumes:
      - ./postgres/data:/var/lib/postgresql/data
      - ./postgres/init:/docker-entrypoint-initdb.d

  pgadmin:
    image: dpage/pgadmin4:8
    container_name: pgadmin
    restart: unless-stopped
    depends_on:
      - postgres
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@example.com
      PGADMIN_DEFAULT_PASSWORD: admin_pass
      TZ: Asia/Taipei
    ports:
      - "5050:80"
    volumes:
      - ./pgadmin:/var/lib/pgadmin
